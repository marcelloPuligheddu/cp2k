&GLOBAL
   ! the project name is made part of most output files... useful to keep order 
   PROJECT WATER
   ! various runtypes (energy, geo_opt, etc.) available.
   RUN_TYPE ENERGY
   ! amount of information printed to output
   IOLEVEL  MEDIUM
&END GLOBAL

&FORCE_EVAL
   ! the electronic structure part of CP2K is named Quickstep
   METHOD Quickstep
   &DFT
      ! basis sets and pseudopotential files can be found in cp2k/data
      BASIS_SET_FILE_NAME HFX_BASIS
      POTENTIAL_FILE_NAME GTH_POTENTIALS

      ! Charge and multiplicity
      CHARGE 0
      MULTIPLICITY 1

      &MGRID
         ! PW cutoff ... depends on the element (basis) too small cutoffs lead to the eggbox effect.
         ! certain calculations (e.g. geometry optimization, vibrational frequencies,
         ! NPT and cell optimizations, need higher cutoffs)
         CUTOFF [Ry] 400
      &END

      &QS
         MIN_PAIR_LIST_RADIUS -1
         ! use the GPW method (i.e. pseudopotential based calculations with the Gaussian and Plane Waves scheme).
         METHOD GPW
         ! default threshold for numerics ~ roughly numerical accuracy of the total energy per electron,
         ! sets reasonable values for all other thresholds.
         EPS_DEFAULT 1.0E-7
         ! used for MD, the method used to generate the initial guess.
         EXTRAPOLATION ASPC
      &END

      &POISSON
         PERIODIC XYZ ! the default, gas phase systems should have 'NONE' and a wavelet solver
      &END
      WFN_RESTART_FILE_NAME WATER-RESTART-GGA.wfn

      &PRINT
         ! compute eigenvalues and homo-lumo gap 
         &MO_CUBES
            NLUMO 4
            NHOMO 4
            WRITE_CUBE .FALSE.
            &EACH
               MD 10
            &END
         &END
      &END
      ! use the OT METHOD for robust and efficient SCF, suitable for all non-metallic systems.
      &SCF
         SCF_GUESS RESTART ! can be used to RESTART an interrupted calculation
         MAX_SCF 30
         EPS_SCF 1.0E-6 ! accuracy of the SCF procedure, for OT typically 1.0E-6 - 1.0E-7, for diagonalization may have to be smaller
         &OT
            ! an accurate preconditioner suitable also for larger systems
            PRECONDITIONER FULL_SINGLE_INVERSE
            ! the most robust choice (DIIS might sometimes be faster, but not as stable).
            MINIMIZER DIIS
         &END OT
         &OUTER_SCF ! repeat the inner SCF cycle 10 times
            MAX_SCF 10
            EPS_SCF 1.0E-6 ! must match the above
         &END
         ! do not store the wfn during MD
         &PRINT
            &RESTART ON
            &END
         &END
      &END SCF

      ! specify the exchange and correlation treatment
      &XC
        ! use a PBE0 functional 
        &XC_FUNCTIONAL
          &PBE
            ! 75% GGA exchange
            SCALE_X 0.75
            ! 100% GGA correlation
            SCALE_C 1.0
          &END PBE
        &END XC_FUNCTIONAL
        &HF
          HFX_LIBRARY libint
          ! 25 % HFX exchange
          FRACTION 0.25
          ! Important to improve scaling from O(N^4) to O(N)
          &SCREENING        
            ! important parameter to get stable HFX calcs (contributions to hfx smaller than EPS_SCHWARZ are not considered)
            EPS_SCHWARZ 1.0E-10
            ! needs a good (GGA) initial guess 
            ! screening on the product between maximum of density matrix elements and ERI
            SCREEN_ON_INITIAL_P TRUE
          &END SCREENING
          &INTERACTION_POTENTIAL
            ! for condensed phase systems
            POTENTIAL_TYPE TRUNCATED
            ! should be less than half the cell
             CUTOFF_RADIUS  6.0
            ! data file needed with the truncated operator
            T_C_G_DATA ./t_c_g.dat
          &END
          &MEMORY
            ! In MB per MPI rank.. use as much as need to get in-core operation
            MAX_MEMORY 4000
            EPS_STORAGE_SCALING 0.1
          &END
        &END
        ! adding Grimme's D3 correction (by default without C9 terms) 
        &VDW_POTENTIAL
           POTENTIAL_TYPE PAIR_POTENTIAL
           &PAIR_POTENTIAL
             PARAMETER_FILE_NAME dftd3.dat
             TYPE DFTD3
             REFERENCE_FUNCTIONAL PBE0
             R_CUTOFF [angstrom] 16
           &END PAIR_POTENTIAL
        &END VDW_POTENTIAL
      &END XC
   &END DFT
   ! description of the system
   &SUBSYS
      &CELL
         ! unit cells that are orthorhombic are more efficient with CP2K
         ABC [angstrom] 12.42 12.42 12.42
      &END CELL

      ! atom coordinates can be in the &COORD section,
      ! or provided as an external file.
      &TOPOLOGY
         COORD_FILE_NAME water.xyz
         COORD_FILE_FORMAT XYZ
      &END

      ! MOLOPT basis sets are fairly costly,
      ! but in the 'DZVP-MOLOPT-SR-GTH' available for all elements
      ! their contracted nature makes them suitable
      ! for condensed and gas phase systems alike.
      &KIND H
         BASIS_SET DZVP-GTH
         POTENTIAL GTH-PBE-q1
      &END KIND
      &KIND O
         BASIS_SET DZVP-GTH
         POTENTIAL GTH-PBE-q6
      &END KIND
   &END SUBSYS
&END FORCE_EVAL
